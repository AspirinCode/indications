---
title: "Merge Indications"
output:
  html_document:
    theme: cosmo
    highlight: pygments
---

```{r, message=FALSE}
library(dplyr)
library(DT)

options(stringsAsFactors = FALSE)
```


#### Compound mappings

```{r}
# construct a rxnorm to drugbank mapping (through FDA-SRS UNII)
rxnorm.df <- dplyr::inner_join(
  file.path('data', 'rxcui-unii-map.tsv') %>%
    read.delim(),
  'http://git.dhimmel.com/drugbank/data/mapping/fdasrs.tsv' %>%
    read.delim()
)

```

#### Disease mappings

```{r}
# read disease ontology slim mappings
domap.df <- 
  'http://git.dhimmel.com/disease-ontology/data/xrefs-prop-slim.tsv' %>%
   read.delim()

# extract the DO to UMLS mapping
umls.df <- domap.df %>%
  dplyr::filter(resource == 'UMLS') %>%
  dplyr::select(-resource) %>%
  dplyr::rename(disease_cui = resource_id)

# extract the DO to ICD9 mapping
icd9.df <- domap.df %>%
  dplyr::filter(resource == 'ICD9') %>%
  dplyr::select(-resource) %>%
  dplyr::rename(disease_icd9 = resource_id)

# extract the DO to OMIM mapping
omim.df <- domap.df %>%
  dplyr::filter(resource == 'OMIM') %>%
  dplyr::select(-resource) %>%
  dplyr::rename(disease_omim = resource_id) %>%
  dplyr::mutate(disease_omim = as.integer(disease_omim))
```

#### Read and map labeledin

```{r}
labin.df <-
  # read labeledin data
  file.path('labeledin', 'data', 'indications.tsv') %>%
  read.delim() %>%
  # remove combo drugs
  dplyr::mutate(rxnorm_id = as.integer(rxnorm_id)) %>%
  dplyr::filter(! is.na(rxnorm_id)) %>%
  # map umls diseases to DO
  dplyr::inner_join(umls.df) %>%
  # map rxnorm compounds to drugbank
  dplyr::inner_join(rxnorm.df)
```

#### Read and map MEDI

```{r}
medi.df <- 
  file.path('medi', 'data', 'medi-umls.tsv') %>%
  read.delim() %>%
  dplyr::inner_join(rxnorm.df)

medi.df <- dplyr::bind_rows(
  umls.df %>%
    dplyr::inner_join(medi.df),
  icd9.df %>%
    dplyr::inner_join(medi.df)
)

```


#### Read and map PREDICT

```{r}
predict.df <- 
  file.path('msb-predict', 'data', 'indications-umls.tsv') %>%
  read.delim() %>%
  dplyr::rename(disease_cui = umls_cui, disease_omim = omim_id)

predict.df <- dplyr::bind_rows(
  umls.df %>%
    dplyr::inner_join(predict.df),
  omim.df %>%
    dplyr::inner_join(predict.df)
)
```

#### Join resources

```{r}
indication.df <- dplyr::bind_rows(
  # LabeledIn
  labin.df %>%
    dplyr::select(doid_code, drugbank_id) %>%
    dplyr::distinct() %>%
    dplyr::mutate(resource = 'labeledin'),
  # MEDI
  medi.df %>%
    dplyr::group_by(doid_code, drugbank_id) %>%
    dplyr::summarize(
      resource = ifelse(max(hps), 'medi_hps', 'medi_lps')
    ) %>%
    dplyr::ungroup(),
  # PREDICT
  predict.df %>%
    dplyr::select(doid_code, drugbank_id) %>%
    dplyr::distinct() %>%
    dplyr::mutate(resource = 'predict')
)

# indications in gold standard
indication.df %>%
  dplyr::filter(resource != 'medi_lps') %>%
  dplyr::select(doid_code, drugbank_id) %>%
  dplyr::distinct() %>%
  nrow()
```


#### Join resources

```{r}
drugbank.df <- 'http://git.dhimmel.com/drugbank/data/drugbank.tsv' %>%
  read.delim(stringsAsFactors=FALSE, na.strings='') %>%
  dplyr::filter(type == 'small molecule') %>%
  dplyr::filter(grepl('approved', groups)) %>%
  dplyr::filter(! is.na(inchikey)) %>%
  dplyr::transmute(drugbank_id, drugbank_name = name)

do.df <- 'http://git.dhimmel.com/disease-ontology/data/slim-terms.tsv' %>%
  read.delim() %>%
  dplyr::transmute(doid_code = doid, doid_name = name)

indication.df <- indication.df %>%
  dplyr::inner_join(drugbank.df) %>%
  dplyr::left_join(do.df)

path <- file.path('data', 'indications.tsv')
write.table(indication.df, path, sep='\t', row.names=FALSE, quote=FALSE)

DT::datatable(indication.df %>% dplyr::filter(resource != 'medi_lps'))
```


```{r}
indication.df %>%
  dplyr::filter(resource != 'medi_lps') %>%
  dplyr::select(-resource) %>%
  dplyr::distinct() %>%
  dplyr::sample_frac(1) %>%
  write.table('data/indications-slim.tsv', sep='\t', row.names=FALSE, quote=FALSE)
```


